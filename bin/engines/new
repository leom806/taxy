#!/usr/bin/env ruby

begin
  load File.expand_path("spring", __dir__)
rescue LoadError => e
  raise unless e.message.include?("spring")
end
require "bundler/setup"
require "active_support/inflector"

engine_name = ARGV[0].downcase

raise 'The engine must have a name' if engine_name.nil?

engine_const = engine_name.camelize

api_template = <<~RUBY
  # require_relative "api/abc_api"

  module #{engine_const}
    module API
    end
  end
RUBY

listeners_template = <<~RUBY
  # require_relative "listeners/abc_listeners"

  module #{engine_const}
    module Listeners
    end
  end
RUBY

rakefile_template = <<~RUBY
  require "bundler/setup"

  load "rails/tasks/statistics.rake"

  require "bundler/gem_tasks"
RUBY

controller_template = <<~RUBY
  module #{engine_const}
    class ApplicationController < ::ApplicationController
    end
  end
RUBY

model_template = <<~RUBY
  module #{engine_const}
    class ApplicationRecord < ::ApplicationRecord
      self.abstract_class = true
    end
  end
RUBY

job_template = <<~RUBY
  module #{engine_const}
    class ApplicationJob < ::ApplicationJob
    end
  end
RUBY

gemspec = <<~RUBY
  require_relative "lib/#{engine_name}/version"

  Gem::Specification.new do |spec|
    spec.name        = "#{engine_name}"
    spec.version     = #{engine_const}::VERSION
    spec.authors     = ["Leonardo Momente"]
    spec.summary     = "Taxy #{engine_name} engine"

    spec.files = Dir["{app,config,db,lib}/**/*", "Rakefile", "README.md"]

    spec.add_dependency "rails", "~> 7.0.1"
  end
RUBY

engine_entrypoint_template = <<~RUBY
  require "#{engine_name}/version"
  require "#{engine_name}/engine"
  require "#{engine_name}/api"

  module #{engine_const}
  end
RUBY

engine_template = <<~RUBY
  module #{engine_const}
    class Engine < ::Rails::Engine
      isolate_namespace #{engine_const}
      config.generators.api_only = true

      config.generators do |g|
        g.api_only = true
        g.test_framework = :rspec
        g.fixture_replacement = :factory_bot
        g.factory_bot dir: "spec/factories"
      end

      initializer "#{engine_name}.factories", after: "factory_bot.set_factory_paths" do
        if defined?(FactoryBot)
          FactoryBot.definition_file_paths << File.expand_path(
            "../../spec/factories",
            __dir__
          )
        end
      end
    end
  end
RUBY

rails_helper_spec_template = <<~RUBY
  # typed: strict
  require "rails_helper"

  # add custom settings for the engine here
RUBY

swagger_spec_template = <<~RUBY
  # typed: strict
  require "swagger_helper"

  # add custom settings for the engine here
RUBY

command = <<~SH
  echo "***********************************************************************"
  echo " -> Creating Engine"
  echo
  rails plugin new engines/#{engine_name} \
                    --mountable \
                    --no-full \
                    --api \
                    --skip-git \
                    --skip-keeps \
                    --skip-action-text \
                    --skip-action-cable \
                    --skip-sprockets \
                    --skip-javascript \
                    --skip-turbolinks \
                    --skip-test \
                    --skip-system-test \
                    --skip-action-mailer \
                    --skip-action-mailbox \
                    --dummy-path=spec/dummy \
                    --database=postgresql
                    > /dev/null

  cd engines/#{engine_name}

  echo

  echo " -> Creating API"
  mkdir lib/#{engine_name}/api/
  echo '#{api_template}' > lib/#{engine_name}/api.rb

  echo " -> Creating Listeners"
  mkdir lib/#{engine_name}/listeners/
  echo '#{listeners_template}' > lib/#{engine_name}/listeners.rb

  echo " -> Updating Rakefile"
  echo '#{rakefile_template}' > Rakefile

  echo " -> Removing License"
  rm MIT-LICENSE

  echo " -> Removing Dummy App"
  rm -rf spec/dummy

  echo " -> Updating App Core"
  echo '#{controller_template}' > app/controllers/#{engine_name}/application_controller.rb
  echo '#{job_template}' > app/jobs/#{engine_name}/application_job.rb
  echo '#{model_template}' > app/models/#{engine_name}/application_record.rb

  echo " -> Removing Binaries"
  rm -rf bin/rails

  echo " -> Updating GemSpec"
  echo '#{gemspec}' > #{engine_name}.gemspec

  echo " -> Removing Gemfile"
  rm Gemfile

  echo " -> Updating Engine Entrypoint"
  echo '#{engine_entrypoint_template}' > lib/#{engine_name}.rb

  echo " -> Updating Engine File"
  echo '#{engine_template}' > lib/#{engine_name}/engine.rb

  echo " -> Creating Rails Helper"
  echo '#{rails_helper_spec_template}' > spec/rails_helper.rb

  echo " -> Creating Swagger Helper"
  echo '#{swagger_spec_template}' > spec/swagger_helper.rb

  cd ../..

  echo
  echo "[#{engine_name.titleize}] Engine Created!"
  echo "***********************************************************************"
SH

system command
